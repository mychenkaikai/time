---
/**
 * MusicPlayer - åƒç´ é£éŸ³ä¹æ’­æ”¾å™¨
 * æ”¯æŒæ’­æ”¾/æš‚åœã€éŸ³é‡æ§åˆ¶ã€è®°ä½ç”¨æˆ·åå¥½
 */

interface Props {
  src: string;
  title: string;
  autoplay?: boolean;
}

const { src, title, autoplay = false } = Astro.props;
---

<div class="music-player window">
  <div class="window-titlebar">
    <span>ğŸµ {title}</span>
  </div>
  <div class="window-body music-player-body">
    <audio id="bgm-audio" src={src} loop></audio>
    
    <div class="player-controls">
      <button id="play-btn" class="control-btn" aria-label="æ’­æ”¾/æš‚åœ">
        <span class="play-icon">â–¶</span>
        <span class="pause-icon" style="display: none;">â¸</span>
      </button>
      
      <div class="volume-control">
        <label for="volume-slider">ğŸ”Š</label>
        <input 
          type="range" 
          id="volume-slider" 
          min="0" 
          max="100" 
          value="50"
          aria-label="éŸ³é‡"
        />
        <span id="volume-value">50%</span>
      </div>
    </div>
    
    <div class="player-info">
      <div class="track-title">{title}</div>
      <div class="track-time">
        <span id="current-time">0:00</span> / <span id="duration">0:00</span>
      </div>
    </div>
  </div>
</div>

<style>
  .music-player {
    position: fixed;
    bottom: var(--spacing-lg);
    right: var(--spacing-lg);
    width: 320px;
    z-index: 1000;
  }

  .music-player-body {
    padding: var(--spacing-sm);
  }

  .player-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
  }

  .control-btn {
    width: 40px;
    height: 40px;
    min-width: 40px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .volume-control {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    flex: 1;
  }

  #volume-slider {
    flex: 1;
    height: 20px;
    cursor: pointer;
  }

  #volume-value {
    font-size: var(--font-size-sm);
    min-width: 35px;
  }

  .player-info {
    font-size: var(--font-size-sm);
    padding: var(--spacing-xs);
    background: var(--input-bg);
    box-shadow: var(--input-border);
  }

  .track-title {
    font-weight: bold;
    margin-bottom: var(--spacing-xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-time {
    color: var(--border-dark);
  }

  /* å“åº”å¼ï¼šç§»åŠ¨ç«¯éšè—æˆ–è°ƒæ•´ä½ç½® */
  @media (max-width: 768px) {
    .music-player {
      width: calc(100% - var(--spacing-md) * 2);
      bottom: var(--spacing-sm);
      right: var(--spacing-sm);
      left: var(--spacing-sm);
    }
  }
</style>

<script>
  // éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘
  const audio = document.getElementById('bgm-audio') as HTMLAudioElement;
  const playBtn = document.getElementById('play-btn') as HTMLButtonElement;
  const playIcon = playBtn.querySelector('.play-icon') as HTMLElement;
  const pauseIcon = playBtn.querySelector('.pause-icon') as HTMLElement;
  const volumeSlider = document.getElementById('volume-slider') as HTMLInputElement;
  const volumeValue = document.getElementById('volume-value') as HTMLElement;
  const currentTimeEl = document.getElementById('current-time') as HTMLElement;
  const durationEl = document.getElementById('duration') as HTMLElement;

  // ä» localStorage è¯»å–éŸ³é‡è®¾ç½®
  const savedVolume = localStorage.getItem('musicVolume');
  if (savedVolume) {
    const volume = parseInt(savedVolume);
    audio.volume = volume / 100;
    volumeSlider.value = savedVolume;
    volumeValue.textContent = `${volume}%`;
  } else {
    audio.volume = 0.5;
  }

  // æ’­æ”¾/æš‚åœåˆ‡æ¢
  playBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline';
    } else {
      audio.pause();
      playIcon.style.display = 'inline';
      pauseIcon.style.display = 'none';
    }
  });

  // éŸ³é‡æ§åˆ¶
  volumeSlider.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const volume = parseInt(target.value);
    audio.volume = volume / 100;
    volumeValue.textContent = `${volume}%`;
    localStorage.setItem('musicVolume', volume.toString());
  });

  // æ—¶é—´æ ¼å¼åŒ–
  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // æ›´æ–°æ’­æ”¾æ—¶é—´
  audio.addEventListener('timeupdate', () => {
    currentTimeEl.textContent = formatTime(audio.currentTime);
  });

  // åŠ è½½å®Œæˆåæ˜¾ç¤ºæ€»æ—¶é•¿
  audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
  });

  // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¦‚æœè®¾ç½®ï¼‰
  const autoplay = audio.hasAttribute('autoplay');
  if (autoplay) {
    // éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½è‡ªåŠ¨æ’­æ”¾ï¼Œè¿™é‡Œåªæ˜¯å°è¯•
    audio.play().catch(() => {
      console.log('è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾');
    });
  }
</script>

