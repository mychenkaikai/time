---
/**
 * MusicPlayer - éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶
 * æ”¯æŒå•æ›²å’Œæ’­æ”¾åˆ—è¡¨
 */

interface Track {
  src: string;
  title: string;
  artist?: string;
}

interface Props {
  tracks: Track[];
  autoplay?: boolean;
}

const { tracks, autoplay = false } = Astro.props;
---

<div class="music-player-container" data-tracks={JSON.stringify(tracks)} data-autoplay={autoplay.toString()}>
  <div class="window-frame music-player">
    <div class="frame-title-bar">
      <div class="frame-title-text">ğŸµ éŸ³ä¹æ’­æ”¾å™¨</div>
      <div class="frame-title-controls">
        <button class="minimize-btn" aria-label="Minimize">_</button>
      </div>
    </div>
    <div class="frame-body">
      <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
      <div class="now-playing">
        <div class="track-title" id="current-title">æœªæ’­æ”¾</div>
        <div class="track-artist" id="current-artist"></div>
      </div>

      <!-- è¿›åº¦æ¡ -->
      <div class="progress-container">
        <input 
          type="range" 
          id="progress-bar" 
          min="0" 
          max="100" 
          value="0"
          class="progress-slider"
        />
      </div>

      <!-- æ—¶é—´æ˜¾ç¤º -->
      <div class="time-display">
        <span id="current-time">0:00</span>
        <span id="duration-time">0:00</span>
      </div>

      <!-- æ’­æ”¾æ§åˆ¶ -->
      <div class="player-controls">
        <button id="prev-btn" class="control-btn" title="ä¸Šä¸€æ›²">â®</button>
        <button id="play-btn" class="control-btn play-btn" title="æ’­æ”¾">â–¶</button>
        <button id="pause-btn" class="control-btn play-btn" style="display: none;" title="æš‚åœ">â¸</button>
        <button id="next-btn" class="control-btn" title="ä¸‹ä¸€æ›²">â­</button>
        <button id="loop-btn" class="control-btn" title="å¾ªç¯æ¨¡å¼">ğŸ”</button>
      </div>

      <!-- éŸ³é‡æ§åˆ¶ -->
      <div class="volume-control">
        <span class="volume-icon">ğŸ”Š</span>
        <input 
          id="volume-slider" 
          type="range" 
          min="0" 
          max="100" 
          value="50"
          class="volume-slider"
        />
      </div>

      <!-- æ’­æ”¾åˆ—è¡¨ -->
      {tracks.length > 1 && (
        <div class="playlist">
          <div class="playlist-header">æ’­æ”¾åˆ—è¡¨ ({tracks.length} é¦–)</div>
          <div class="playlist-items" id="playlist-items">
            {tracks.map((track, index) => (
              <div class="playlist-item" data-index={index}>
                <span class="track-number">{index + 1}.</span>
                <div class="track-info">
                  <div class="track-name">{track.title}</div>
                  {track.artist && <div class="track-artist-small">{track.artist}</div>}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</div>

<script>
  import { Howl } from 'howler';

  const container = document.querySelector('.music-player-container') as HTMLElement;
  if (container) {
    const tracksData = JSON.parse(container.dataset.tracks || '[]');
    const autoplay = container.dataset.autoplay === 'true';
    
    const playBtn = document.getElementById('play-btn') as HTMLButtonElement;
    const pauseBtn = document.getElementById('pause-btn') as HTMLButtonElement;
    const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
    const loopBtn = document.getElementById('loop-btn') as HTMLButtonElement;
    const volumeSlider = document.getElementById('volume-slider') as HTMLInputElement;
    const progressBar = document.getElementById('progress-bar') as HTMLInputElement;
    const currentTitle = document.getElementById('current-title') as HTMLElement;
    const currentArtist = document.getElementById('current-artist') as HTMLElement;
    const currentTime = document.getElementById('current-time') as HTMLElement;
    const durationTime = document.getElementById('duration-time') as HTMLElement;
    const playlistItems = document.getElementById('playlist-items');
    const minimizeBtn = document.querySelector('.minimize-btn') as HTMLButtonElement;
    const musicPlayer = document.querySelector('.music-player') as HTMLElement;

    let currentTrackIndex = 0;
    let sound: Howl | null = null;
    let updateTimer: number;
    let loopMode = 'all'; // 'all', 'one', 'none'
    let isMinimized = false;

    // åŠ è½½ä¿å­˜çš„éŸ³é‡
    const savedVolume = localStorage.getItem('bgm_volume');
    const initialVolume = savedVolume ? parseFloat(savedVolume) : 0.5;
    volumeSlider.value = (initialVolume * 100).toString();

    // æ ¼å¼åŒ–æ—¶é—´
    const formatTime = (secs: number) => {
      const minutes = Math.floor(secs / 60) || 0;
      const seconds = Math.floor(secs - minutes * 60) || 0;
      return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    };

    // æ›´æ–°è¿›åº¦
    const updateProgress = () => {
      if (sound && sound.playing()) {
        const seek = sound.seek() || 0;
        const duration = sound.duration();
        const percent = (seek / duration) * 100;
        progressBar.value = percent.toString();
        currentTime.textContent = formatTime(Math.round(seek));
        updateTimer = requestAnimationFrame(updateProgress);
      }
    };

    // æ›´æ–°æ’­æ”¾åˆ—è¡¨é«˜äº®
    const updatePlaylistHighlight = () => {
      if (playlistItems) {
        const items = playlistItems.querySelectorAll('.playlist-item');
        items.forEach((item, index) => {
          if (index === currentTrackIndex) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      }
    };

    // åŠ è½½å¹¶æ’­æ”¾éŸ³ä¹
    const loadTrack = (index: number, shouldPlay: boolean = false) => {
      if (index < 0 || index >= tracksData.length) return;
      
      currentTrackIndex = index;
      const track = tracksData[index];

      // åœæ­¢å½“å‰éŸ³ä¹
      if (sound) {
        sound.unload();
      }

      // æ›´æ–°æ˜¾ç¤º
      currentTitle.textContent = track.title;
      currentArtist.textContent = track.artist || '';
      currentArtist.style.display = track.artist ? 'block' : 'none';
      updatePlaylistHighlight();

      // åˆ›å»ºæ–°éŸ³ä¹
      sound = new Howl({
        src: [track.src],
        html5: true,
        volume: initialVolume,
        onplay: () => {
          playBtn.style.display = 'none';
          pauseBtn.style.display = 'inline-block';
          requestAnimationFrame(updateProgress);
        },
        onpause: () => {
          playBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          cancelAnimationFrame(updateTimer);
        },
        onstop: () => {
          playBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          cancelAnimationFrame(updateTimer);
        },
        onload: () => {
          const duration = sound?.duration() || 0;
          durationTime.textContent = formatTime(Math.round(duration));
        },
        onend: () => {
          // æ’­æ”¾ç»“æŸï¼Œæ ¹æ®å¾ªç¯æ¨¡å¼å†³å®šä¸‹ä¸€æ­¥
          if (loopMode === 'one') {
            sound?.play();
          } else if (loopMode === 'all') {
            const nextIndex = (currentTrackIndex + 1) % tracksData.length;
            loadTrack(nextIndex, true);
          } else {
            // loopMode === 'none'
            if (currentTrackIndex < tracksData.length - 1) {
              loadTrack(currentTrackIndex + 1, true);
            }
          }
        }
      });

      if (shouldPlay) {
        sound.play();
      }
    };

    // æ’­æ”¾æŒ‰é’®
    playBtn.addEventListener('click', () => {
      if (!sound) {
        loadTrack(0, true);
      } else {
        sound.play();
      }
    });

    // æš‚åœæŒ‰é’®
    pauseBtn.addEventListener('click', () => {
      sound?.pause();
    });

    // ä¸Šä¸€æ›²
    prevBtn.addEventListener('click', () => {
      const prevIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : tracksData.length - 1;
      loadTrack(prevIndex, sound?.playing() || false);
    });

    // ä¸‹ä¸€æ›²
    nextBtn.addEventListener('click', () => {
      const nextIndex = (currentTrackIndex + 1) % tracksData.length;
      loadTrack(nextIndex, sound?.playing() || false);
    });

    // å¾ªç¯æ¨¡å¼
    loopBtn.addEventListener('click', () => {
      if (loopMode === 'all') {
        loopMode = 'one';
        loopBtn.textContent = 'ğŸ”‚';
        loopBtn.title = 'å•æ›²å¾ªç¯';
      } else if (loopMode === 'one') {
        loopMode = 'none';
        loopBtn.textContent = 'â¡ï¸';
        loopBtn.title = 'é¡ºåºæ’­æ”¾';
      } else {
        loopMode = 'all';
        loopBtn.textContent = 'ğŸ”';
        loopBtn.title = 'åˆ—è¡¨å¾ªç¯';
      }
    });

    // éŸ³é‡æ§åˆ¶
    volumeSlider.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value) / 100;
      if (sound) {
        sound.volume(value);
      }
      localStorage.setItem('bgm_volume', value.toString());
    });

    // è¿›åº¦æ¡æ§åˆ¶
    progressBar.addEventListener('input', (e) => {
      if (sound) {
        const percent = parseInt((e.target as HTMLInputElement).value);
        const duration = sound.duration();
        const seekTo = (percent / 100) * duration;
        sound.seek(seekTo);
      }
    });

    // æ’­æ”¾åˆ—è¡¨ç‚¹å‡»
    if (playlistItems) {
      playlistItems.addEventListener('click', (e) => {
        const item = (e.target as HTMLElement).closest('.playlist-item') as HTMLElement;
        if (item) {
          const index = parseInt(item.dataset.index || '0');
          loadTrack(index, true);
        }
      });
    }

    // æœ€å°åŒ–/å±•å¼€
    minimizeBtn.addEventListener('click', () => {
      isMinimized = !isMinimized;
      if (isMinimized) {
        musicPlayer.classList.add('minimized');
        minimizeBtn.textContent = 'â–¡';
      } else {
        musicPlayer.classList.remove('minimized');
        minimizeBtn.textContent = '_';
      }
    });

    // è‡ªåŠ¨æ’­æ”¾
    if (autoplay) {
      loadTrack(0, true);
    } else {
      loadTrack(0, false);
    }
  }
</script>

<style>
  .music-player-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  .music-player {
    width: 320px;
    background: var(--window-bg, #ffffff);
    border: 2px solid var(--border-darkest, #000000);
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    transition: all 0.3s;
  }

  .music-player.minimized .frame-body {
    display: none;
  }

  .frame-title-bar {
    background: var(--titlebar-bg, #cccccc);
    color: var(--titlebar-text, #000000);
    padding: 4px 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--border-darkest, #000000);
    cursor: move;
  }

  .frame-title-text {
    font-weight: bold;
    font-size: 14px;
  }

  .frame-title-controls {
    display: flex;
    gap: 4px;
  }

  .minimize-btn {
    background: var(--button-bg, #eeeeee);
    border: 1px solid var(--border-dark, #808080);
    width: 20px;
    height: 20px;
    padding: 0;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }

  .minimize-btn:hover {
    background: #dddddd;
  }

  .frame-body {
    padding: 12px;
  }

  .now-playing {
    text-align: center;
    margin-bottom: 12px;
    min-height: 40px;
  }

  .track-title {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .track-artist {
    font-size: 12px;
    color: #666;
  }

  .progress-container {
    margin-bottom: 8px;
  }

  .progress-slider {
    width: 100%;
    height: 4px;
    cursor: pointer;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #666;
    margin-bottom: 12px;
  }

  .player-controls {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .control-btn {
    background: var(--button-bg, #eeeeee);
    border: 1px solid var(--border-dark, #808080);
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .control-btn:hover {
    background: #dddddd;
  }

  .control-btn:active {
    transform: translate(1px, 1px);
  }

  .play-btn {
    padding: 8px 16px;
    font-size: 16px;
  }

  .volume-control {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .volume-icon {
    font-size: 16px;
  }

  .volume-slider {
    flex: 1;
    height: 4px;
    cursor: pointer;
  }

  .playlist {
    border-top: 1px solid var(--border-dark, #808080);
    padding-top: 8px;
    margin-top: 8px;
  }

  .playlist-header {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 8px;
    color: #666;
  }

  .playlist-items {
    max-height: 150px;
    overflow-y: auto;
  }

  .playlist-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .playlist-item:hover {
    background: #f0f0f0;
    border-color: var(--border-dark, #808080);
  }

  .playlist-item.active {
    background: var(--link-color, #0000ff);
    color: #ffffff;
  }

  .track-number {
    font-size: 11px;
    color: #999;
    min-width: 20px;
  }

  .playlist-item.active .track-number {
    color: #ffffff;
  }

  .track-info {
    flex: 1;
    min-width: 0;
  }

  .track-name {
    font-size: 12px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-artist-small {
    font-size: 11px;
    color: #666;
  }

  .playlist-item.active .track-artist-small {
    color: #ccccff;
  }

  /* å“åº”å¼ */
  @media (max-width: 768px) {
    .music-player-container {
      bottom: 10px;
      right: 10px;
    }

    .music-player {
      width: 280px;
    }
  }
</style>
