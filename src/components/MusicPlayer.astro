---
import '98.css';

interface Props {
  src: string;
  title: string;
  autoplay?: boolean;
}

const { src, title, autoplay = false } = Astro.props;
---

<div class="music-player window" data-src={src} data-autoplay={autoplay.toString()}>
  <div class="title-bar">
    <div class="title-bar-text">ðŸŽµ {title}</div>
    <div class="title-bar-controls">
      <button aria-label="Minimize"></button>
      <button aria-label="Close"></button>
    </div>
  </div>
  <div class="window-body">
    <div class="player-controls">
      <button id="play-btn">Play</button>
      <button id="pause-btn" style="display: none;">Pause</button>
      
      <div class="status-bar-field" style="flex: 1; text-align: center;">
        <span id="time-display">0:00 / 0:00</span>
      </div>
    </div>
    
    <div class="field-row" style="margin-top: 10px;">
      <label for="volume-slider">Volume:</label>
      <input 
        id="volume-slider" 
        type="range" 
        min="0" 
        max="100" 
        value="50"
      />
    </div>
  </div>
</div>

<script>
  import { Howl } from 'howler';

  const playerElement = document.querySelector('.music-player') as HTMLElement;
  if (playerElement) {
    const src = playerElement.dataset.src;
    const autoplay = playerElement.dataset.autoplay === 'true';
    
    const playBtn = playerElement.querySelector('#play-btn') as HTMLButtonElement;
    const pauseBtn = playerElement.querySelector('#pause-btn') as HTMLButtonElement;
    const volumeSlider = playerElement.querySelector('#volume-slider') as HTMLInputElement;
    const timeDisplay = playerElement.querySelector('#time-display') as HTMLElement;

    // Load volume from localStorage
    const savedVolume = localStorage.getItem('bgm_volume');
    const initialVolume = savedVolume ? parseFloat(savedVolume) : 0.5;
    volumeSlider.value = (initialVolume * 100).toString();

    let sound: Howl | null = null;
    let updateTimer: number;

    const formatTime = (secs: number) => {
      const minutes = Math.floor(secs / 60) || 0;
      const seconds = Math.floor(secs - minutes * 60) || 0;
      return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    };

    const updateTime = () => {
      if (sound && sound.playing()) {
        const seek = sound.seek() || 0;
        const duration = sound.duration();
        timeDisplay.textContent = `${formatTime(Math.round(seek))} / ${formatTime(Math.round(duration))}`;
        updateTimer = requestAnimationFrame(updateTime);
      }
    };

    const initSound = () => {
      if (sound) return;

      sound = new Howl({
        src: [src!],
        html5: true, // Force HTML5 Audio to stream large files
        volume: initialVolume,
        autoplay: autoplay,
        loop: true,
        onplay: () => {
          playBtn.style.display = 'none';
          pauseBtn.style.display = 'inline-block';
          requestAnimationFrame(updateTime);
        },
        onpause: () => {
          playBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          cancelAnimationFrame(updateTimer);
        },
        onstop: () => {
          playBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          cancelAnimationFrame(updateTimer);
          timeDisplay.textContent = '0:00 / 0:00';
        },
        onload: () => {
           const duration = sound?.duration() || 0;
           timeDisplay.textContent = `0:00 / ${formatTime(Math.round(duration))}`;
        }
      });
    };

    playBtn.addEventListener('click', () => {
      if (!sound) initSound();
      sound?.play();
    });

    pauseBtn.addEventListener('click', () => {
      sound?.pause();
    });

    volumeSlider.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value) / 100;
      if (sound) {
        sound.volume(value);
      }
      localStorage.setItem('bgm_volume', value.toString());
    });

    // Auto init if autoplay is true (browser might block it though)
    if (autoplay) {
      initSound();
    }
  }
</script>

<style>
  .music-player {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 250px;
    z-index: 1000;
  }
  
  .player-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }
</style>
