---
/**
 * PostLayout - æ–‡ç« é¡µå¸ƒå±€
 * ä¸‰æ å¸ƒå±€ï¼šé¡¶éƒ¨å¯¼èˆª + å·¦ä¾§åˆ†ç±»å¯¼èˆª + å³ä¾§æ–‡ç« å†…å®¹
 */

import BaseLayout from './BaseLayout.astro';
import TopNav from '../components/TopNav.astro';
import SideNav from '../components/SideNav.astro';
import WindowFrame from '../components/WindowFrame.astro';
import MusicPlayer from '../components/MusicPlayer.astro';
import VideoBox from '../components/VideoBox.astro';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    date: Date;
    updated?: Date;
    theme: 'retro-web' | 'win98' | 'winxp' | 'macos9' | 'web1';
    category: string;
    subcategory?: string;
    tags: string[];
    mood?: string;
    media?: {
      bgm?: {
        src: string;
        title: string;
        autoplay: boolean;
      } | Array<{
        src: string;
        title: string;
        artist?: string;
      }>;
      video?: {
        platform: string;
        id: string;
        title: string;
      };
    };
    customStyles?: {
      backgroundColor?: string;
      accentColor?: string;
    };
  };
  slug: string;
}

const { frontmatter, slug } = Astro.props;

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

const baseUrl = import.meta.env.BASE_URL;
---

<script>
  // é˜…è¯»è¿›åº¦æ¡é€»è¾‘
  const progressContainer = document.getElementById('reading-progress');
  const progressFill = progressContainer?.querySelector('.progress-fill') as HTMLElement;
  
  if (progressContainer && progressFill) {
    window.addEventListener('scroll', () => {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = (scrollTop / docHeight) * 100;
      
      progressFill.style.width = `${scrollPercent}%`;
      
      if (scrollTop > 100) {
        progressContainer.classList.add('visible');
      } else {
        progressContainer.classList.remove('visible');
      }
    });
  }
</script>

<BaseLayout 
  title={frontmatter.title} 
  description={frontmatter.description}
  theme={frontmatter.theme}
>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <TopNav />

  <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
  {frontmatter.media?.bgm && (
    <MusicPlayer 
      tracks={Array.isArray(frontmatter.media.bgm) 
        ? frontmatter.media.bgm 
        : [{ 
            src: frontmatter.media.bgm.src, 
            title: frontmatter.media.bgm.title,
            artist: undefined
          }]
      }
      autoplay={Array.isArray(frontmatter.media.bgm) ? false : frontmatter.media.bgm.autoplay}
    />
  )}

  <!-- ä¸»å†…å®¹åŒºï¼šå·¦ä¾§å¯¼èˆª + å³ä¾§æ–‡ç«  -->
  <div class="main-layout">
    <!-- å·¦ä¾§åˆ†ç±»å¯¼èˆª -->
    <div class="sidebar">
      <SideNav currentSlug={slug} />
    </div>

    <!-- å³ä¾§æ–‡ç« å†…å®¹ -->
    <div class="content-area">
      <WindowFrame title={frontmatter.title} class="article-window">
        <!-- æ–‡ç« å…ƒä¿¡æ¯ -->
        <div class="post-meta">
          <div class="post-category">
            ğŸ“ åˆ†ç±»: {frontmatter.category}
            {frontmatter.subcategory && (
              <span> / {frontmatter.subcategory}</span>
            )}
          </div>
          
          <div class="post-date">
            ğŸ“… å‘å¸ƒäº: {formatDate(frontmatter.date)}
            {frontmatter.updated && (
              <span> | æ›´æ–°äº: {formatDate(frontmatter.updated)}</span>
            )}
          </div>
          
          {frontmatter.mood && (
            <div class="post-mood">
              ğŸ’­ å¿ƒæƒ…: {frontmatter.mood}
            </div>
          )}
          
          {frontmatter.tags.length > 0 && (
            <div class="post-tags">
              ğŸ·ï¸ æ ‡ç­¾: 
              {frontmatter.tags.map((tag) => (
                <a href={`${baseUrl}tags/${tag}`} class="tag">{tag}</a>
              ))}
            </div>
          )}
        </div>

        {frontmatter.media?.video && (
          <div class="post-video" style="margin-bottom: var(--spacing-md);">
            <VideoBox 
              platform={frontmatter.media.video.platform as any} 
              id={frontmatter.media.video.id}
              title={frontmatter.media.video.title}
            />
          </div>
        )}

        <hr class="divider" />

        <!-- æ–‡ç« å†…å®¹ -->
        <article class="post-content">
          <slot />
        </article>

        <!-- è¿”å›é¦–é¡µ -->
        <hr class="divider" />
        <div class="post-footer">
          <a href={baseUrl} class="back-link">â† è¿”å›é¦–é¡µ</a>
        </div>
      </WindowFrame>
    </div>
  </div>

  <style>
    /* é˜…è¯»è¿›åº¦æ¡ */
    .reading-progress {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .reading-progress.visible {
      opacity: 1;
    }

    .progress-bar {
      height: 4px;
      background: transparent;
      width: 100%;
    }

    .progress-fill {
      height: 100%;
      background: var(--link-color); /* Use theme color */
      width: 0%;
      transition: width 0.1s;
      box-shadow: 0 0 4px var(--link-color);
    }

    /* ä¸»å¸ƒå±€ï¼šå·¦ä¾§å¯¼èˆª + å³ä¾§å†…å®¹ */
    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: var(--spacing-md);
      align-items: start;
    }

    .sidebar {
      /* ä¾§è¾¹æ æ ·å¼åœ¨ SideNav ç»„ä»¶ä¸­ */
    }

    .content-area {
      min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    }

    .post-meta {
      font-size: var(--font-size-sm);
      color: var(--text-color);
      margin-bottom: var(--spacing-md);
    }

    .post-category,
    .post-date,
    .post-mood,
    .post-tags {
      margin-bottom: var(--spacing-xs);
    }

    .post-category {
      font-weight: bold;
      color: var(--link-color);
    }

    .post-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      align-items: center;
    }

    .tag {
      background: var(--button-bg);
      padding: 2px 8px;
      text-decoration: none;
      box-shadow: var(--button-shadow);
      font-size: var(--font-size-sm);
    }

    .tag:hover {
      background: var(--link-hover-bg);
      color: var(--link-hover-text);
    }

    .divider {
      border: none;
      border-top: 1px solid var(--border-dark);
      border-bottom: 1px solid var(--border-light);
      margin: var(--spacing-md) 0;
    }

    .post-content {
      line-height: 1.8;
    }

    .post-content :global(h2) {
      margin-top: var(--spacing-lg);
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--border-dark);
    }

    .post-content :global(h3) {
      margin-top: var(--spacing-md);
    }

    .post-content :global(p) {
      margin-bottom: var(--spacing-md);
    }

    .post-content :global(ul),
    .post-content :global(ol) {
      margin-bottom: var(--spacing-md);
      padding-left: var(--spacing-lg);
    }

    .post-content :global(li) {
      margin-bottom: var(--spacing-xs);
    }

    .post-content :global(blockquote) {
      border-left: 4px solid var(--border-dark);
      padding-left: var(--spacing-md);
      margin: var(--spacing-md) 0;
      background: rgba(0, 0, 0, 0.05);
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .post-content :global(code) {
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 2px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .post-content :global(pre) {
      background: rgba(0, 0, 0, 0.1);
      padding: var(--spacing-md);
      overflow-x: auto;
      margin-bottom: var(--spacing-md);
      border: 1px solid var(--border-dark);
    }

    .post-content :global(pre code) {
      background: none;
      padding: 0;
    }

    .post-footer {
      text-align: center;
    }

    .back-link {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--button-bg);
      text-decoration: none;
      box-shadow: var(--button-shadow);
    }

    .back-link:hover {
      background: var(--link-hover-bg);
      color: var(--link-hover-text);
    }

    .back-link:active {
      box-shadow: var(--button-active-shadow);
      transform: translate(1px, 1px);
    }

    /* å“åº”å¼ */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: 2;
      }

      .content-area {
        order: 1;
      }
    }
  </style>
</BaseLayout>

